# AI Service Contract

This document defines the contract between the **api-service** and **ai-service** for question generation and related operations.

---

## Question Generation

### Endpoint
```
POST {AI_SERVICE_URL}/ai/questions/generate
```

### Request

```json
{
  "role_name": "Software Engineer",
  "job_description": "Full job description text...",
  "resume": "Optional resume text for additional context"
}
```

**Request Fields:**
- `role_name` (required): Job role/title (string, 1-200 chars)
- `job_description` (required): Full job description (string, 10-10000 chars)
- `resume` (optional): Candidate resume text for personalized questions (string, max 50000 chars)

### Response

```json
{
  "identifiers": {
    "skills": ["Python", "FastAPI", "PostgreSQL"],
    "focus_areas": ["API design", "Database optimization"],
    "difficulty": "medium",
    "tone": "professional"
  },
  "questions": [
    {
      "text": "How would you design a REST API for a real-time chat application?",
      "category": "technical",
      "difficulty": "medium",
      "skills": ["Python", "API design"],
      "source": "from_library",
      "question_id": "550e8400-e29b-41d4-a716-446655440000",
      "metadata": {
        "subcategory": "system_design",
        "compatible_roles": ["Software Engineer", "Backend Developer"],
        "required_skills": ["Python"],
        "industry_tags": ["technology"]
      },
      "identifiers": {
        "question_id": "550e8400-e29b-41d4-a716-446655440000",
        "category": "technical",
        "difficulty": "medium",
        "role": "Software Engineer",
        "tags": ["API", "design", "real-time"]
      }
    },
    {
      "text": "Describe a time when you had to optimize database performance.",
      "category": "behavioral",
      "difficulty": "easy",
      "skills": ["Database", "Problem-solving"],
      "source": "newly_generated",
      "question_id": null,
      "metadata": {
        "subcategory": "problem_solving",
        "compatible_roles": ["Software Engineer"],
        "required_skills": ["Database"],
        "generation_prompt_hash": "abc123..."
      }
    }
  ],
  "embedding_vectors": {
    "550e8400-e29b-41d4-a716-446655440000": [0.1, 0.2, 0.3, ...],
    "temporary-id-123": [0.4, 0.5, 0.6, ...]
  }
}
```

### Response Fields

#### Root Level

- `identifiers` (required): Global metadata about the role/job
  - `skills` (array of strings): Extracted skills from job description
  - `focus_areas` (array of strings): Key focus areas identified
  - `difficulty` (string): Overall difficulty level ("easy", "medium", "hard")
  - `tone` (string): Recommended tone ("professional", "friendly", "technical")
  
- `questions` (required): Array of question objects
  - Each question must have the structure defined below
  
- `embedding_vectors` (optional but preferred): Dictionary mapping question IDs to embedding vectors
  - Keys: `question_id` from the questions array (or temporary ID for new questions)
  - Values: Array of 1536 floats (OpenAI embedding format)
  - **Note**: If missing, api-service will generate embeddings via `/embeddings/generate` endpoint

#### Question Object

- `text` (required): The question text (string)
- `category` (required): Question category ("technical", "behavioral", "system_design", etc.)
- `difficulty` (required): Difficulty level ("easy", "medium", "hard")
- `skills` (required): Array of skills this question tests (array of strings)
- `source` (required): Source indicator
  - `"from_library"`: Question exists in PostgreSQL question bank
  - `"newly_generated"`: Question was just generated by AI
- `question_id` (optional): 
  - For `source="from_library"`: Stable UUID from database (required)
  - For `source="newly_generated"`: Can be null or temporary ID (will be assigned by api-service)
- `metadata` (optional): Additional question metadata (object)
- `identifiers` (optional): Per-question identifiers (object, same shape as global identifiers)

### Behavior

1. **Identifier Extraction**: ai-service extracts skills, focus areas, difficulty, and tone from the job description
2. **Question Retrieval**: ai-service searches Qdrant/PostgreSQL for matching existing questions
3. **Question Generation**: ai-service generates new questions if needed to meet target count
4. **Embedding Generation**: ai-service generates embeddings for all questions (both library and new)
5. **Response Assembly**: ai-service returns structured response with `questions`, `identifiers`, and `embedding_vectors`

### Error Responses

**400 Bad Request:**
```json
{
  "detail": "Invalid request: role_name cannot be empty"
}
```

**422 Unprocessable Entity:**
```json
{
  "detail": "Job description must be at least 10 characters"
}
```

**500 Internal Server Error:**
```json
{
  "detail": "Failed to generate questions: <error message>"
}
```

---

## Embedding Generation

### Endpoint
```
POST {AI_SERVICE_URL}/embeddings/generate
```

### Request

```json
{
  "text": "Question text to embed"
}
```

### Response

```json
{
  "embedding": [0.1, 0.2, 0.3, ...]  // Array of 1536 floats
}
```

**Note**: This is used as a fallback by api-service when `embedding_vectors` are missing from question generation response.

---

## Answer Analysis

### Endpoint
```
POST {AI_SERVICE_URL}/analyze/answer
```

### Request

```json
{
  "job_description": "Job description text",
  "question": "Interview question text",
  "answer": "Candidate's answer text",
  "role": "Job role name"
}
```

### Response

```json
{
  "analysis": "Detailed analysis of the answer...",
  "score": {
    "clarity": 8.5,
    "confidence": 7.0,
    "technical": 9.0,
    "overall": 8.2
  },
  "suggestions": [
    "Consider providing more specific examples",
    "Elaborate on the technical approach used"
  ],
  "multi_agent_analysis": {
    "content_agent": {...},
    "delivery_agent": {...},
    "technical_agent": {...}
  }
}
```

---

## Implementation Notes

### Question ID Handling

- **Library Questions**: Must include stable `question_id` UUID. api-service will look up existing question by this ID to avoid duplicates.
- **New Questions**: May have null `question_id` or temporary ID. api-service will create new Question record and assign UUID.

### Embedding Vectors

- **Preferred**: Always include `embedding_vectors` in question generation response to avoid additional HTTP calls.
- **Fallback**: If missing, api-service calls `/embeddings/generate` for each new question (adds latency).
- **Mapping**: Embedding keys should match `question_id` values from questions array (or temporary IDs that map correctly).

### Source Field Consistency

- Use `source="from_library"` only for questions that exist in PostgreSQL
- Use `source="newly_generated"` for questions created during this request
- api-service uses this to determine persistence strategy

---

## Version History

- **v1.0** (Current): Initial contract with structured question generation
  - Supports both library retrieval and new generation
  - Includes embedding vectors in response
  - Per-question and global identifiers

